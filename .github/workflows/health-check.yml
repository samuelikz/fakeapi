name: ğŸ’š Health Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Executa a cada 30 minutos
    - cron: '*/30 * * * *'
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸš€ Start application
      run: |
        npm start &
        sleep 10 # Aguarda a aplicaÃ§Ã£o inicializar
        
    - name: ğŸ’š Test health endpoints
      run: |
        echo "ğŸ§ª Testing health endpoints..."
        
        # Test health basic
        echo "Testing /health..."
        curl -f http://localhost:8000/health || exit 1
        
        # Test health detailed
        echo "Testing /health/detailed..."
        curl -f http://localhost:8000/health/detailed || exit 1
        
        # Test health ping
        echo "Testing /health/ping..."
        response=$(curl -s http://localhost:8000/health/ping)
        if [ "$response" != "pong" ]; then
          echo "âŒ Expected 'pong', got '$response'"
          exit 1
        fi
        
        # Test health ready
        echo "Testing /health/ready..."
        curl -f http://localhost:8000/health/ready || exit 1
        
        # Test health live
        echo "Testing /health/live..."
        curl -f http://localhost:8000/health/live || exit 1
        
        echo "âœ… All health endpoints working correctly!"
        
    - name: ğŸ“Š Health status summary
      run: |
        echo "ğŸ’š Health Check Summary:"
        echo "âœ… /health - Basic health check"
        echo "âœ… /health/detailed - Detailed health check"
        echo "âœ… /health/ping - Ping endpoint"
        echo "âœ… /health/ready - Readiness check"
        echo "âœ… /health/live - Liveness check"
        echo ""
        echo "ğŸ‰ All health checks passed!"
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up..."
        pkill -f "node.*server.js" || true
        
    - name: ğŸ“ Health check report
      if: always()
      run: |
        echo "ğŸ“‹ Health Check Report:"
        echo "ğŸ• Timestamp: $(date)"
        echo "ğŸŒ Environment: GitHub Actions"
        echo "ğŸ“Š Status: ${{ job.status }}"
        echo "ğŸ’š Health endpoints: All operational"
